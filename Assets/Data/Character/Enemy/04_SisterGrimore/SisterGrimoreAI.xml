<AIGraph Name="SisterGrimoreAI" DefaultState="Entry_Peace">

<!-- 옵션 설정 -->
    <!-- 인지 옵션값 설정 -->
    <GlobalVariable Name="gv_CognitiveRange"    Value="5.0"/>   <!-- PC 인지 거리 : 해당 거리 내 PC 존재 시 인지한다. -->
    <GlobalVariable Name="gv_CognitiveDelay"    Value="0.5"/>   <!-- 인지 지연 시간 : 해당 거리 내 PC 존재 시 인지까지 이루어지는 지연 시간. -->

    <!-- 평화 행동 설정-->
    <GlobalVariable Name="gv_IsPeaceMotion"           Value="false"/>       <!-- 평화 모션 사용 : True일 시 평화 모션 재생, False일 경우 랜덤 이동 -->
    
    <!-- 간격 거리 설정 -->
    <GlobalVariable Name="gv_AttackRangeMin"           Value="1.5"/>       <!-- 근거리 기준 : 해당 값보다 낮으면 근거리로 판단한다. -->
    <GlobalVariable Name="gv_AttackRangeMax"           Value="4.0"/>       <!-- 원거리 기준 : 해당 값보다 높으면 원거리로 판단한다. -->

    <!-- 가드 옵션 설정 -->
    <GlobalVariable Name="gv_GuardTime"                     Value="3.0"/>       <!-- 방어 지속 시간 -->
    <GlobalVariable Name="gv_GuardBrokenThreshold"          Value="1.0"/>       <!-- 가드 브레이크 공격을 막을 수 있는 횟수 -->

    <!-- 패시브 방어 반응 임계치 설정 -->
    <GlobalVariable Name="gv_HitCountThreshold"             Value="2.0"/>       <!-- 누적 피격 횟수 트리거 : 해당 횟수 충족 시 패시브 방어 동작 (가드를 제외한 모든 피격 카운트) -->
    <GlobalVariable Name="gv_GuardCountThreshold"           Value="2.0"/>       <!-- 누적 가드 횟수 트리거 : 해당 횟수 충족 시 패시브 방어 동작 (가드 중 모든 피격 시 카운트) -->
    
    <!-- 행동 옵션값 설정 -->
    <GlobalVariable Name="gv_TransitionDelay"   Value="0.2"/>                   <!-- [보류] State 전환 지연시간 (State 최소 실행 시간) -->

    <!-- 커스텀 옵션 -->    
    <CustomValue Name="HasKnife" Value="0.0"/> <!-- 0:Off, 1:On -->
    <CustomEvent_KnifeSpawn>
        <AIEvent Type="SetCustomValue" Name="HasKnife" Value="1.0"/>
    </CustomEvent_KnifeSpawn>
    <CustomEvent_KnifeRelease>
        <AIEvent Type="SetCustomValue" Name="HasKnife" Value="0.0"/>
    </CustomEvent_KnifeRelease>

    <CustomValue Name="KnifeCount" Value="0.0"/>
    <CustomEvent_AddKnife>
        <AIEvent Type="AddCustomValue" Name="KnifeCount" Value="1.0"/>
    </CustomEvent_AddKnife>
    <CustomEvent_DeleteKnife>
        <AIEvent Type="AddCustomValue" Name="KnifeCount" Value="-1.0"/>
    </CustomEvent_DeleteKnife>

    <CustomValue Name="IsBarriorOn" Value="0.0"/> <!-- 0:Off, 1:On -->
    <CustomEvent_BarriorActivated>
        <AIEvent Type="SetCustomValue" Name="IsBarriorOn" Value="1.0"/>
    </CustomEvent_BarriorActivated>
    <CustomEvent_BarriorBroken>
        <AIEvent Type="SetCustomValue" Name="IsBarriorOn" Value="0.0"/>
    </CustomEvent_BarriorBroken>
<!-- 옵션 설정 -->

<!-- 패키지 인클루드 -->
    <!-- 패키지 인클루드 : 공통 리액션 -->
    <Include Path="Assets/Data/AILibrary/Package/EmptyPackage.xml"/>               <!-- 공백 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonDeadPackage.xml"/>          <!-- 사망 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonHitPackage.xml"/>           <!-- 피격 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonGuardBrokenPackage.xml"/>   <!-- 가드 해제 패키지 -->
    
    <!-- 패키지 인클루드 : 평화 모션 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonPeaceMotionPackage.xml"/>    <!-- 평화 모션 패키지 -->
    
    <!-- 패키지 인클루드 : 이동 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonIdlePackage.xml"/>          <!-- 대기 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonRandMovePackage.xml"/>      <!-- 랜덤 이동 패키지-->
    <Include Path="Assets/Data/AILibrary/Package/CommonChasePackage.xml"/>         <!-- 추격 이동 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonAlertPackage.xml"/>         <!-- 경계 이동 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonAlertMovePackage.xml"/>
    <Include Path="Assets/Data/AILibrary/Package/CommonAwayPackage.xml"/>          <!-- 후진 이동 패키지 -->
    
    <!-- 패키지 인클루드 : 전투 상태 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonAttackPackage.xml"/>         <!-- 일반 공격 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonLockOnAttackPackage.xml"/>   <!-- 락온 공격 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonGuardPackage.xml"/>          <!-- 일반 가드 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonLockOnAllGuardPackage.xml"/> <!-- 락온 가드 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonDodgePackage.xml"/>          <!-- 회피 패키지 -->
    <!-- TODO :  전용 스킬 패키지 추가-->
    <Include Path="Assets/Data/Character/Enemy/04_SisterGrimore/SisterGrimoreSkillPackage.xml"/>        <!-- 스킬 패키지 -->

<!-- 패키지 인클루드 -->

<!-- 간이 테스트 스크립트 -->
   <Test Package="EmptyPackage">
        <Branch Condition="CurrentPackageEnd" Execute="Entry_Battle"/>
    </Test>
<!-- 간이 테스트 스크립트 -->

<!-- 브랜치 셋 -->
    <!-- 전투 행동 초기화 브랜치 셋 -->
    <BranchSet Name="BattlePackageEndSet">
        <Branch Condition="CurrentPackageEnd" Execute="Entry_Battle"/>
    </BranchSet>

    <!-- 피격 리액션 브랜치 셋 -->
    <BranchSet Name="HitReactionSet">
        <Branch Condition="Dead" Execute="Dead"/>
        <Branch Condition="Hit && getFrameTag_HitAvail" Execute="Hit"/>
        
        <!-- 논가드 상태에서 가드브레이크를 피격한 경우 -->
        <Branch Condition="GuardBreakFail && getFrameTag_GbAvail
                        && (customValue_IsBarriorOn == 0.0)" Execute="GuardBroken"/>
        <!-- 가드 상태에서 가드브레이크를 피격한 경우 -->
        <Branch Condition="GuardBroken && getFrameTag_GbAvail 
                        && (getStat_GuardCount >= gv_GuardBrokenThreshold)
                        && (customValue_IsBarriorOn == 0.0)" Execute="GuardBroken"/> 

        <!-- 피격 리액션 누적에 따른 방어행동 -->
        <Branch Condition="(gv_HitCountThreshold > 0.0)
                        && (gv_HitCountThreshold <= getStat_HitCount)
                        && (gv_TransitionDelay <= GraphExecutedTime)" Execute="Battle_Defense"/>
        <!-- 가드 성공 누적에 따른 반격행동 -->
        <Branch Condition="(gv_GuardCountThreshold > 0.0)
                        && (gv_GuardCountThreshold <= getStat_GuardCount)
                        && (gv_TransitionDelay <= GraphExecutedTime)" Execute="Battle_Counter"/>
    </BranchSet>
<!-- 브랜치 셋 -->

<!-- 스테이트 -->
    <!-- 고정 AI 스테이트 : 평화 상태 -->
        <Entry_Peace Package="CommonIdlePackage">
            <Branch Condition="gv_IsPeaceMotion" Execute="Peace_MotionStart"/>
            <Branch Condition="true" Execute="Peace_RandMove"/>
        </Entry_Peace>

        <Peace_MotionStart Package="CommonPeaceMotionPackage" EntryNode="AI_Loop">
            <UseBranchSet Name="HitReactionSet"/>
            <Branch Condition="(TargetDistance <= gv_CognitiveRange)
                            && (GraphExecutedTime >= gv_CognitiveDelay)" Execute="Peace_MotionEnd"/>
        </Peace_MotionStart>
        <Peace_MotionEnd Package="CommonPeaceMotionPackage" EntryNode="AI_End">
            <UseBranchSet Name="HitReactionSet"/>
            <Branch Condition="CurrentPackageEnd" Execute="Entry_Battle"/>
        </Peace_MotionEnd>

        <Peace_RandMove Package="CommonRandMovePackage">
            <UseBranchSet Name="HitReactionSet"/>
            <Branch Condition="(TargetDistance <= gv_CognitiveRange)
                            && (GraphExecutedTime >= gv_CognitiveDelay)" Execute="Entry_Battle"/>
        </Peace_RandMove>
    <!-- 고정 AI 스테이트 : 평화 상태 -->

    <!-- 고정 AI 스테이트 : 전투 상태 : 분기 -->
        <Entry_Battle Package="CommonIdlePackage">
            <Branch Condition="true"  Execute="Battle_JudgeDist"/>
        </Entry_Battle>

        <Battle_JudgeDist Package="CommonIdlePackage">
            <Branch Condition="(TargetDistance > gv_AttackRangeMax)" Execute="Battle_Far"/>             <!-- 사거리 밖 -->
            <Branch Condition="(TargetDistance < gv_AttackRangeMin)" Execute="Battle_Closer"/>          <!-- 초근접 -->
            <Branch Condition="true" Execute="Battle_Range"/>                                           <!-- 사정거리 -->
        </Battle_JudgeDist>
        
        <Battle_Far Package="CommonIdlePackage">
            <Branch Condition="(customValue_HasKnife == 1.0)" Execute="KnifeRelease"/>
            <Branch Condition="(customValue_IsBarriorOn == 0.0) && aiGraphCoolTime_Barrior" Execute="Barrior"/>
            <Branch Condition="true" Execute="Chase"/>
        </Battle_Far>
        <Battle_Closer Package="CommonIdlePackage">
            <Branch Weight="RandBoolean^true" Condition="(customValue_IsBarriorOn == 0.0) && aiGraphCoolTime_Dodge" Execute="Dodge"/>
            <Branch Condition="(customValue_HasKnife == 1.0)" Execute="KnifeRelease"/>
            <Branch Condition="aiGraphCoolTime_Discharge" Execute="Discharge"/>
            <Branch Condition="true" Execute="Away"/>
        </Battle_Closer>
        <Battle_Range Package="CommonIdlePackage">
            <Branch Condition="(customValue_HasKnife == 1.0)" Execute="KnifeRelease"/>
            <Branch Condition="aiGraphCoolTime_Knife && (customValue_HasKnife == 0.0) && (customValue_KnifeCount <= 3.0)" Execute="Knife"/>
            <Branch Weight="RandBoolean^True" Condition="(customValue_IsBarriorOn == 0.0) && aiGraphCoolTime_Barrior" Execute="Barrior"/>
            <Branch Condition="aiGraphCoolTime_Pray" Execute="Pray"/>
            <Branch Condition="true" Execute="Alert"/>
        </Battle_Range>

        <Battle_Defense Package="CommonIdlePackage">
            <Branch Condition="true" Execute="Defense"/>
        </Battle_Defense>
        <Battle_Counter Package="CommonIdlePackage">
            <Branch Condition="true" Execute="Counter"/>
        </Battle_Counter>
    <!-- 고정 AI 스테이트 : 전투 상태 : 분기 -->

    
    <!-- AI 스테이트 : 전투 상태 : 이동 -->
    <Idle Package="CommonIdlePackage">
        <UseBranchSet Name="HitReactionSet"/>
        <!-- Movement Release Sample -->
        <Branch Condition="(TargetDistance <= gv_AttackRangeMax)" Execute="Battle_JudgeDist"/>      <!-- Distance Check-->
        <Branch Condition="(GraphExecutedTime >= 1.0)" Execute="Entry_Battle"/>                     <!-- Executed Time Check-->
    </Idle>
    <Chase Package="CommonChasePackage">
        <UseBranchSet Name="HitReactionSet"/>
        <!-- Movement Release Sample -->
        <Branch Condition="(TargetDistance <= gv_AttackRangeMax)" Execute="Battle_JudgeDist"/>      <!-- Distance Check-->
        <Branch Condition="(GraphExecutedTime >= 1.0)" Execute="Entry_Battle"/>                     <!-- Executed Time Check-->
    </Chase>
    <Away Package="CommonAwayPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <!-- Movement Release Sample -->
        <Branch Condition="(TargetDistance >= gv_AttackRangeMin)" Execute="Battle_JudgeDist"/>      <!-- Distance Check-->
        <Branch Condition="(GraphExecutedTime >= 1.0)" Execute="Entry_Battle"/>                     <!-- Executed Time Check-->
    </Away>
    <Alert Package="CommonAlertPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <!-- Movement Release Sample -->
        <Branch Condition="(TargetDistance > gv_AttackRangeMax) 
                        || (TargetDistance < gv_AttackRangeMin)" Execute="Battle_JudgeDist"/>      <!-- Distance Check-->
        <Branch Condition="(GraphExecutedTime >= 1.0)" Execute="Entry_Battle"/>                     <!-- Executed Time Check-->
    </Alert>

    <!-- AI 스테이트 : 전투 상태 : 스킬 -->
    <Pray Package="SisterGrimoreSkillPackage" EntryNode="AI_Pray" CoolTime="3.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Pray>
    <Discharge Package="SisterGrimoreSkillPackage" EntryNode="AI_DischargeReady" CoolTime="7.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Discharge>
    <Barrior Package="SisterGrimoreSkillPackage" EntryNode="AI_Barrior" CoolTime="15.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Barrior>
    <Knife Package="SisterGrimoreSkillPackage" EntryNode="AI_KnifeReady" CoolTime="10.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Knife>
    <KnifeRelease Package="SisterGrimoreSkillPackage" EntryNode="AI_KnifeRelease">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </KnifeRelease>

    <Guard Package="CommonGuardPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="(GraphExecutedTime  >= gv_GuardTime)" Execute="Entry_Battle"/>
    </Guard>
    <Dodge Package="CommonDodgePackage" CoolTime="10">
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Weight="RandBoolean^true" Condition="(customValue_IsBarriorOn == 0.0) && aiGraphCoolTime_Barrior" Execute="Barrior"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Dodge>

    <!-- AI 스테이트 : 전투 상태 : 패시브 방어 -->
    <Defense Package="CommonDodgePackage">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Defense>
    <Counter Package="SisterGrimoreSkillPackage" EntryNode="AI_Pray">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Counter>

    <!-- AI 스테이트 : 피격 상태 -->
    <Hit Package="CommonHitPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Hit>

    <GuardBroken Package="CommonGuardBrokenPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </GuardBroken>

    <Dead Package="CommonDeadPackage">
    </Dead>
<!-- 스테이트 -->

</AIGraph>