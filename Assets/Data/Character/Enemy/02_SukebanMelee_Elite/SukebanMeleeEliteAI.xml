<AIGraph Name="SukebanMeleeEliteAI" DefaultState="Entry_Battle">

<!-- 옵션 설정 -->

    <!-- 전투 상태 행동 타입 설정 -->
    <!-- 공격 거리 설정 -->
    <GlobalVariable Name="gv_MeleeAttackRangeMin"           Value="0.0"/>       <!-- 최소 공격 사거리 : Value보다 PC가 가까우면 공격하지 않는다. -->
    <GlobalVariable Name="gv_MeleeAttackRangeMax"           Value="1.8"/>       <!-- 최대 공격 사거리 : Value보다 PC가 멀면 공격하지 않는다. -->
    <GlobalVariable Name="gv_StdPassiveAttitude"           Value="4.0"/>       <!-- 장외 기준 거리 : 전투 가능 기준 범위 -->

    <!-- 가드 옵션 설정 -->
    <GlobalVariable Name="gv_GuardTime"                     Value="3.0"/>       <!-- 방어 지속 시간 -->
    <GlobalVariable Name="gv_GuardBrokenThreshold"          Value="3.0"/>       <!-- 가드 브레이크 공격을 막을 수 있는 횟수 -->
    <GlobalVariable Name="gv_GuardLoopCount"                Value="3.0"/>       <!-- [보류] 가드 성공 시 패시브 방어 루프 횟수 -->
    <!-- 워프 여부 설정 -->
    <GlobalVariable Name="gv_bIsSystemChase"                Value="True"/>     <!-- 시스템 추격: 일정 거리 이상일 시 PC로 워프한다. (카메라 밖에서 동작) -->
    <!-- 이동 거리 설정 -->
    <GlobalVariable Name="gv_SystemChaseThreshold"          Value="9.75"/>     <!-- 시스템 추격 거리: 카메라 범위 값. 카메라 바깥으로 사라지지 않게 추격 -->
    <GlobalVariable Name="gv_MoveThreshold"                 Value="3.0"/>       <!-- 최대 거리 : PC와 Value 이상 거리가 벌어진 경우 이동한다. -->
    <GlobalVariable Name="gv_StopThreshold"                 Value="2.3"/>       <!-- 최소 거리 : PC와 Value 이상 거리가 가까워진 경우 정지 또는 경계한다. -->
    <GlobalVariable Name="gv_AwayThreshold"                 Value="1.8"/>       <!-- 최소 거리 : PC와 Value 이상 거리가 가까워진 경우 거리를 벌린다. -->
    <!-- 패시브 방어 반응 임계치 설정 -->
    <GlobalVariable Name="gv_HitCountThreshold"             Value="3.0"/>       <!-- 누적 피격 횟수 트리거 : 해당 횟수 충족 시 패시브 방어 동작 (가드를 제외한 모든 피격 카운트) -->
    <GlobalVariable Name="gv_HitCountThreshold_Tsuba"       Value="1.0"/>       <!-- 츠바용 누적 피격 횟수 트리거 : 해당 횟수 충족 시 패시브 방어 동작 (가드를 제외한 모든 피격 카운트) -->
    <GlobalVariable Name="gv_GuardCountThreshold"           Value="2.0"/>       <!-- 누적 가드 횟수 트리거 : 해당 횟수 충족 시 패시브 방어 동작 (가드 중 모든 피격 시 카운트) -->
    <!-- 패시브 방어(누적 피격) 반응 타입 설정 -->
        <!-- TODO: 피격 리액션이 상황에 따라 다른 것으로 실행될 수 있음. 복수 선택 가능하게. -->
    <GlobalVariable Name="gv_bIsDodgeToPassiveDef_Hit"      Value="True"/>      <!-- 누적 피격 시 패시브 방어 : 회피 타입 -->
    <GlobalVariable Name="gv_bIsCounterToPassiveDef_Hit"    Value="True"/>      <!-- 누적 피격 시 패시브 방어 : 반격 타입 -->
    <GlobalVariable Name="gv_bIsGuardToPassiveDef_Hit"      Value="False"/>      <!-- 누적 피격 시 패시브 방어 : 방어 타입 -->
    <!-- 패시브 방어(누적 가드) 반응 타입 설정 -->
        <!-- TODO: 피격 리액션이 상황에 따라 다른 것으로 실행될 수 있음. 복수 선택 가능하게. -->
    <GlobalVariable Name="gv_bIsDodgeToPassiveDef_Guard"    Value="False"/>      <!-- 누적 피격 시 패시브 방어 : 회피 타입 -->
    <GlobalVariable Name="gv_bIsCounterToPassiveDef_Guard"  Value="False"/>     <!-- 누적 피격 시 패시브 방어 : 반격 타입 -->
    <!-- 패시브 방어 실행 지연 시간 설정 -->
    <GlobalVariable Name="gv_PassiveDef_Hit_DelayTime" Value="0.0"/>            <!-- 누적 피격 반응 지연 시간-->
    <GlobalVariable Name="gv_PassiveDef_Guard_DelayTime" Value="0.2"/>            <!-- 누적 가드 반응 지연 시간-->

<!-- 옵션 설정 -->

<!-- 패키지 인클루드 -->
    <!-- 패키지 인클루드 : 공통 -->
    <Include Path="Assets/Data/AILibrary/Package/EmptyPackage.xml"/>          <!-- 사망 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonDeadPackage.xml"/>          <!-- 사망 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonHitPackage.xml"/>           <!-- 피격 패키지 -->
    
    <Include Path="Assets/Data/AILibrary/Package/CommonGuardBrokenPackage.xml"/>   <!-- 가드 해제 패키지 -->
    <!-- 패키지 인클루드 : 평화 상태 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonIdlePackage.xml"/>          <!-- 대기 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonRandMovePackage.xml"/>      <!-- 랜덤 이동 패키지-->
                                                                                <!-- 지정 이동 패키지 (보류) -->
    <!-- 패키지 인클루드 : 전투 상태 -->
    <Include Path="Assets/Data/Character/Enemy/02_SukebanMelee_Elite/SukebanMeleeEliteSlashPackage.xml"/>           <!-- Skill -->
    <Include Path="Assets/Data/Character/Enemy/02_SukebanMelee_Elite/SukebanMeleeEliteTrippleSlashPackage.xml"/>    <!-- Skill -->
    <Include Path="Assets/Data/Character/Enemy/02_SukebanMelee_Elite/SukebanMeleeEliteUziPackage.xml"/>             <!-- Skill -->
    <Include Path="Assets/Data/Character/Enemy/02_SukebanMelee_Elite/SukebanMeleeEliteSpwanUziPackage.xml"/>        <!-- Skill -->
    <Include Path="Assets/Data/Character/Enemy/02_SukebanMelee_Elite/SukebanMeleeEliteTsubaPackage.xml"/>           <!-- Skill -->
    <Include Path="Assets/Data/AILibrary/Package/CommonChasePackage.xml"/>         <!-- 추격 이동 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonSystemChasePackage.xml"/>   <!-- 시스템 추격 이동 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonAlertPackage.xml"/>         <!-- 경계 이동 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonAwayPackage.xml"/>          <!-- 후진 이동 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonAttackPackage.xml"/>        <!-- 일반 공격 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonLockOnAttackPackage.xml"/>  <!-- 락온 공격 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonLockOnAllAttackPackage.xml"/>  <!-- 락온 공격 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonBumpAttackPackage.xml"/>    <!-- 충돌 공격 패키지 (공격 성공 시 액션 전환)-->
    <Include Path="Assets/Data/AILibrary/Package/CommonLaserAttackPackage.xml"/>   <!-- 빔 공격 패키지 (공격 시 추적 불가)-->
    <Include Path="Assets/Data/AILibrary/Package/CommonDodgePackage.xml"/>         <!-- 회피 패키지 -->
    <Include Path="Assets/Data/AILibrary/Package/CommonGuardPackage.xml"/>         <!-- 가드 패키지 -->
<!-- 패키지 인클루드 -->

    <!-- Std Values -->
    <GlobalVariable Name="gv_UziLimit" Value="0.0"/>        <!-- 건틀렛 소환 기준값 -->
    <!-- Custom Value -->
    <CustomValue Name="CurrentUziCount" Value="0.0"/>

    <CustomEvent_CountUzi>
        <AIEvent Type="AddCustomValue" Name="CurrentUziCount" Value="1.0"/>
    </CustomEvent_CountUzi>
    <CustomEvent_DiscountUzi>
        <AIEvent Type="AddCustomValue" Name="CurrentUziCount" Value="-1.0"/>
    </CustomEvent_DiscountUzi>

<!-- 간이 테스트 스크립트 -->
    <BranchSet Name="TestBranchA">
        <Branch Condition="Dead" Execute="Dead"/>
    </BranchSet>
    <BranchSet Name="TestBranchB">
        <Branch Condition="Dead" Execute="Dead"/>
    </BranchSet>

   <Test Package="EmptyPackage">
        <UseBranchSet Name="TestBranchA"/>
        <UseBranchSet Name="TestBranchB"/>
    </Test>
<!-- 간이 테스트 스크립트 -->

<!-- 브랜치 셋 -->
    <BranchSet Name="IsPlayerDead">
        <Branch Condition="Dead" Execute="Dead"/>
        <Branch Condition="getTargetFrameTag_Dead" Execute="EnemyWin"/>
    </BranchSet>
    
    <!-- 전투 행동 초기화 브랜치 셋 -->
    <BranchSet Name="BattlePackageEndSet">
        <Branch Condition="CurrentPackageEnd" Execute="Entry_Battle"/>
    </BranchSet>

    <!-- 전투 행동 분기 브랜치 셋-->
    <BranchSet Name="BattleEntrySet">
        <Branch Condition="aiGraphCoolTime_Battle_Attack
                        && (TargetDistance >= gv_MeleeAttackRangeMin)
                        && (TargetDistance <= gv_MeleeAttackRangeMax)"  Execute="Battle_Attack"/>
        <Branch Condition="true"                                        Execute="Battle_Attack"/>
    </BranchSet>
    
    <!-- (미사용) 전투 이동 분기 브랜치 셋 -->
    <BranchSet Name="BattleMovementJudgeSet">
        <Branch Condition="gv_bIsSystemChase && (TargetDistance >= gv_SystemChaseThreshold)" Execute="WarpChase"/>
        <Branch Condition="TargetDistance > gv_StdPassiveAttitude" Execute="Chase"/>
        <Branch Weight="RandBoolean^True" Condition="(aiGraphCoolTime_Slash) || (aiGraphCoolTime_TrippleSlash && (gv_UziLimit >= customValue_CurrentUziCount))" Execute="Chase"/>
        <Branch Weight="RandBoolean^False" Condition="(aiGraphCoolTime_Uzi) || (aiGraphCoolTime_TrippleUzi && (gv_UziLimit >= customValue_CurrentUziCount))" Execute="Away"/>
    </BranchSet>

    <!-- 전투 공격 분기 브랜치 셋 -->
    <BranchSet Name="BattleAttackJudgeSet">
        <!-- TODO : 거리기반 스킬 분기 -->
        <Branch Condition="(TargetDistance > gv_MeleeAttackRangeMax)" Execute="JudgeRangedAttack"/>
        <Branch Condition="(TargetDistance <= gv_MeleeAttackRangeMax)" Execute="JudgeMeleeAttack"/>
    </BranchSet>

    <!-- 전투 패시브 방어 분기 브랜치 셋 -->
    <BranchSet Name="BattleDefenseByHitJudgeSet">
        <Branch Weight="RandBoolean^True"   Condition="gv_bIsDodgeToPassiveDef_Hit" Execute="Dodge"/>
        <Branch Weight="RandBoolean^False"  Condition="gv_bIsGuardToPassiveDef_Hit" Execute="Guard"/>
    </BranchSet>
    <BranchSet Name="BattleDefenseByGuardJudgeSet">
        <Branch Condition="gv_bIsDodgeToPassiveDef_Guard"    Execute="Dodge"/>
        <Branch Condition="gv_bIsCounterToPassiveDef_Guard"  Execute="Tsuba"/>
    </BranchSet>

    <!-- 피격 리액션 브랜치 셋 -->
    <BranchSet Name="HitReactionSet">
        <Branch Condition="Dead" Execute="Dead"/>
        <Branch Weight="RandBoolean^True"
                Condition="Hit && getFrameTag_HitAvail && (gv_HitCountThreshold_Tsuba == getStat_HitCount)
                        && gv_bIsCounterToPassiveDef_Hit
                        && aiGraphCoolTime_Tsuba"       Execute="Tsuba"/>
        <Branch Condition="Hit && getFrameTag_HitAvail" Execute="Hit"/>
        <Branch Condition="GuardBreakFail && getFrameTag_GbAvail" Execute="GuardBroken"/>
        <Branch Condition="GuardBroken && (getStat_GuardCount >= gv_GuardBrokenThreshold) && getFrameTag_GbAvail" Execute="GuardBroken"/> <!-- TODO : 일반 공격도 카운트 되긴 하나, 가드 브레이크로만 파괴 가능한 상태 -->
        <Branch Condition="(gv_bIsDodgeToPassiveDef_Hit || gv_bIsGuardToPassiveDef_Hit || gv_bIsCounterToPassiveDef_Hit) 
                        && (gv_HitCountThreshold <= getStat_HitCount)
                        && (gv_PassiveDef_Hit_DelayTime <= GraphExecutedTime)" Execute="Battle_DefenseByHit"/>
        <Branch Condition="(gv_bIsDodgeToPassiveDef_Guard || gv_bIsCounterToPassiveDef_Guard)
                        && (gv_GuardCountThreshold <= getStat_GuardCount)
                        && (gv_PassiveDef_Guard_DelayTime <= GraphExecutedTime)" Execute="Battle_DefenseByGuard"/>
    </BranchSet>
<!-- 브랜치 셋 -->

<!-- Preset State -->
    <Entry_Battle Package="CommonIdlePackage">
        <UseBranchSet Name="BattleEntrySet"/>
    </Entry_Battle>

    <Battle_Move Package="CommonIdlePackage"> <!-- Battle_Attack에서 이동 포함하여 일괄 판단-->
        <UseBranchSet Name="BattleMovementJudgeSet"/>
    </Battle_Move>

    <Battle_Attack Package="CommonIdlePackage">
        <UseBranchSet Name="BattleAttackJudgeSet"/>
    </Battle_Attack>
    
    <Battle_CounterAttack Package="CommonIdlePackage">
        <UseBranchSet Name="BattleAttackJudgeSet"/>
    </Battle_CounterAttack>

    <Battle_DefenseByHit Package="CommonIdlePackage">
        <UseBranchSet Name="BattleDefenseByHitJudgeSet"/>
    </Battle_DefenseByHit>

    <Battle_DefenseByGuard Package="CommonIdlePackage">
        <UseBranchSet Name="BattleDefenseByGuardJudgeSet"/>
    </Battle_DefenseByGuard>
<!-- Preset State -->

<!-- AI State -->
    <!-- AI 스테이트 : 전투 분기 -->
    <!-- TODO : 크게 근거리 / 원거리로 구분하여 스킬 사용, 패키지는 직접 작성 -->
    <JudgeMeleeAttack Package="CommonIdlePackage">
        <!-- TODO : 근거리용 스킬 작성, 공격이든 방어든, 이동이든 쿨타임 및 조건 기반 사용 -->
        <Branch Weight="RandBoolean^True" Condition="aiGraphCoolTime_Slash" Execute="Slash"/>
        <Branch Weight="RandBoolean^True" Condition="aiGraphCoolTime_TrippleSlash" Execute="TrippleSlash"/>
        <Branch Weight="RandBoolean^False" Condition="aiGraphCoolTime_Dodge" Execute="Dodge"/>
        <Branch Condition="True" Execute="Away"/>
    </JudgeMeleeAttack>
    <JudgeRangedAttack Package="CommonIdlePackage">
        <!-- TODO : 원거리용 스킬 작성, 공격이든 방어든, 이동이든 쿨타임 및 조건 기반 사용 -->
        <Branch Weight="RandBoolean^True" Condition="aiGraphCoolTime_TrippleSlash" Execute="TrippleSlash"/>
        <Branch Weight="RandBoolean^True" Condition="aiGraphCoolTime_Uzi" Execute="Uzi"/>
        <Branch Weight="RandBoolean^True" Condition="aiGraphCoolTime_TrippleUzi && (gv_UziLimit >= customValue_CurrentUziCount)" Execute="TrippleUzi"/>
        <Branch Condition="True" Execute="Chase"/>
    </JudgeRangedAttack>

    <!-- AI 스테이트 : 전투 상태 : 이동 -->
    <!-- Movement State List -->
    <WarpChase Package="CommonSystemChasePackage">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </WarpChase>
    <Chase Package="CommonChasePackage">
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="(TargetDistance < gv_MeleeAttackRangeMax)" Execute="JudgeMeleeAttack"/>
    </Chase>

    <Away Package="CommonAwayPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="(TargetDistance >= gv_MeleeAttackRangeMax)" Execute="JudgeRangedAttack"/>
    </Away>
    <!-- Movement State List -->

    <!-- AI 스테이트 : 전투 상태 : 공격 -->
    <!-- Skill State List-->

    <Slash Package="SukebanMeleeEliteSlashPackage" CoolTime="2.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Slash>
    <TrippleSlash Package="SukebanMeleeEliteTrippleSlashPackage" CoolTime="7.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </TrippleSlash>
    <Uzi Package="SukebanMeleeEliteUziPackage" CoolTime="4.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Uzi>
    <TrippleUzi Package="SukebanMeleeEliteSpwanUziPackage" CoolTime="10.0">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </TrippleUzi>

    <Tsuba Package="SukebanMeleeEliteTsubaPackage" CoolTime="7.0">
        <Branch Condition="Dead" Execute="Dead"/>
        <Branch Condition="getTargetFrameTag_Dead" Execute="EnemyWin"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Tsuba>
    <!-- Skill State List-->

    <!-- AI 스테이트 : 전투 상태 : 패시브 방어 -->
    <!-- Passive Defense Skill List -->
    <Dodge Package="CommonDodgePackage" CoolTime="10.0">
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Weight="RandBoolean^True" Condition="CurrentPackageEnd && aiGraphCoolTime_TrippleUzi && (gv_UziLimit >= customValue_CurrentUziCount)" Execute="TrippleUzi"/>
        <Branch Weight="RandBoolean^False" Condition="CurrentPackageEnd && aiGraphCoolTime_TrippleSlash" Execute="TrippleSlash"/>
        <Branch Condition="CurrentPackageEnd" Execute="Uzi"/>

        <UseBranchSet Name="BattlePackageEndSet"/>
    </Dodge>

    <Guard Package="CommonGuardPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="(GraphExecutedTime  >= gv_GuardTime)" Execute="Entry_Battle"/>
    </Guard>
    <!-- Passive Defense Skill List -->

    <!-- AI 스테이트 : 피격 상태 -->
    <Hit Package="CommonHitPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </Hit>

    <GuardBroken Package="CommonGuardBrokenPackage">
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="BattlePackageEndSet"/>
    </GuardBroken>

    <Dead Package="CommonDeadPackage">
    </Dead>

    <EnemyWin Package="CommonIdlePackage">
        <Branch Condition="getTargetFrameTag_Dead == false" Execute="Entry_Battle"/>
    </EnemyWin>
<!-- AI State -->

</AIGraph>