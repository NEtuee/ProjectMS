<AIGraph Name="AobaChanAI" DefaultState="Entry">

    <Include Path="Common/CommonTestPackage.xml"/>

    <Include Path="Common/CommonDeadPackage.xml"/>
    <Include Path="Common/CommonHitPackage.xml"/>
    <Include Path="Common/CommonAlertMovePackage.xml"/>
    <Include Path="Common/CommonChasePackage.xml"/>
    <Include Path="Common/CommonIdlePackage.xml"/>
    <Include Path="Common/CommonGuardBrokenPackage.xml"/>
    <Include Path="Common/CommonGroggyPackage.xml"/>
    <Include Path="Common/CommonDashPackage.xml"/>

    <Include Path="Enemy/NozawaAoba/AobaRaisenPackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaChoraisenPackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaStormRaisenPackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaChargeRaisenPackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaUnwaverRaisenPackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaEmpPackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaWarpChasePackage.xml"/>
    <Include Path="Enemy/NozawaAoba/AobaTsubaPackage.xml"/>

    <Include Path="Enemy/NozawaAoba/AobaDodgePackage.xml"/>

    <CustomValue Name="CurrentRaisenCount" Value="0.0"/>
    <CustomValue Name="CurrentStormCount" Value="0.0"/>

    <CustomEvent_CountRaisen>
        <AIEvent Type="AddCustomValue" Name="CurrentRaisenCount" Value="1.0"/>
    </CustomEvent_CountRaisen>
    <CustomEvent_ResetRaisen>
        <AIEvent Type="SetCustomValue" Name="CurrentRaisenCount" Value="0.0"/>
    </CustomEvent_ResetRaisen>
    <CustomEvent_CountStorm>
        <AIEvent Type="AddCustomValue" Name="CurrentStormCount" Value="1.0"/>
    </CustomEvent_CountStorm>
    <CustomEvent_ResetStorm>
        <AIEvent Type="SetCustomValue" Name="CurrentStormCount" Value="0.0"/>
    </CustomEvent_ResetStorm>

    <!-- Alert Movement Reaction Distance Value -->
    <GlobalVariable Name="gv_AobaReactAlertMoveDist" Value="1.8"/>
    <GlobalVariable Name="gv_AkaneAttackDist" Value="1.5"/> 

    <!-- Std Values -->
    <GlobalVariable Name="gv_SystemChaseRange" Value="9.75"/>     <!-- 카메라 범위 값. 카메라 바깥으로 사라지지 않게 추격 -->
    <GlobalVariable Name="gv_AobaStdDistance" Value="2.0"/>     <!-- 아오바 거리 판단 기준 -->
    

    <!-- Dodge Pattern -->
    <GlobalVariable Name="gv_najimiHitCountFast" Value="1.0"/>      <!-- 피격 허용 횟수 (빠름)-->
    <GlobalVariable Name="gv_najimiHitCountNormal" Value="2.0"/>    <!-- 피격 허용 횟수 (보통)-->
    <GlobalVariable Name="gv_najimiHitCountSlow" Value="3.0"/>      <!-- 피격 허용 횟수 (느림)-->
    
    <!-- Groggy Pattern -->
    <GlobalVariable Name="gv_najimiStdBattle" Value="20.0"/>     <!-- 나지미 그로기 기준 배틀 포인트 -->

    <!-- Test -->
        <Test Package="AobaStormRaisenPackage">
            <Branch Condition="Hit && getFrameTag_HitAvail" Execute="TestHit"/>
            <Branch Condition="(GuardBreakFail || GuardBroken) && getFrameTag_GbAvail" Execute="TestGuardBroken"/>
            <Branch Condition="CurrentPackageEnd" Execute="Test"/>
        </Test>

        <Test2 Package="AobaUnwaverRaisenPackage">
            <Branch Condition="Hit && getFrameTag_HitAvail" Execute="TestHit"/>
            <Branch Condition="(GuardBreakFail || GuardBroken) && getFrameTag_GbAvail" Execute="TestGuardBroken"/>
            <Branch Condition="CurrentPackageEnd" Execute="Test"/>
        </Test2>

        <TestHit Package="CommonHitPackage">
            <Branch Condition="CurrentPackageEnd" Execute="Test"/>
        </TestHit>

        <TestGuardBroken Package="CommonGuardBrokenPackage">
            <Branch Condition="CurrentPackageEnd" Execute="Test"/>
        </TestGuardBroken>
    <!-- Test -->
    
    <!-- BranchSet -->
        <BranchSet Name="IsPlayerDead">
            <Branch Condition="Dead" Execute="Dead"/>
            <Branch Condition="getTargetFrameTag_Dead" Execute="EnemyWin"/>
        </BranchSet>

        <BranchSet Name="WarpChaseSet">
            <Branch Condition="TargetDistance >= gv_SystemChaseRange" Execute="WarpChase"/>
        </BranchSet>

        <BranchSet Name="HitReactionSet">
            <Branch Condition="Dead" Execute="Dead"/>
            <Branch Condition="(getStat_Battle >= gv_najimiStdBattle)" Execute="Groggy"/>
            <Branch Weight="NajimiJudgeDodge^Fast" Condition="(Hit || GuardBreakFail || GuardBroken) && (getStat_HitCount >= gv_najimiHitCountFast)" Execute="JudgeHitReaction"/> <!-- Attack 프레임 태그로 바꿀까.-->
            <Branch Weight="NajimiJudgeDodge^Normal" Condition="(Hit || GuardBreakFail || GuardBroken) && (getStat_HitCount >= gv_najimiHitCountNormal)" Execute="JudgeHitReaction"/>
            <Branch Weight="NajimiJudgeDodge^Slow" Condition="(Hit || GuardBreakFail || GuardBroken) && (getStat_HitCount >= gv_najimiHitCountSlow)" Execute="JudgeHitReaction"/>
            <!-- TODO: 수평회피 부동뢰섬 확률 설정 -->
            <Branch Weight="AobaDodge^False" Condition="Hit && getFrameTag_HitAvail" Execute="Hit"/>
            <Branch Weight="AobaDodge^True" Condition="Hit && getFrameTag_HitAvail" Execute="UnwaverRaisen"/> <!-- 확정 회피 패턴 (수평회피 부동뢰섬)-->
            <Branch Condition="(GuardBreakFail || GuardBroken) && getFrameTag_GbAvail" Execute="GuardBroken"/>
        </BranchSet>
    <!-- BranchSet -->

    <!-- State -->
    <Entry Package="CommonIdlePackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="WarpChaseSet"/>

        <Branch Condition="true" Execute="JudgeDist"/>
    </Entry>

    <!-- 거리 판단 -->
    <JudgeDist Package="CommonIdlePackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="WarpChaseSet"/>

        <Branch Condition="TargetDistance > gv_AobaStdDistance" Execute="JudgeApproachAttack"/>
        <Branch Condition="TargetDistance <= gv_AobaStdDistance" Execute="JudgeShortAttack"/>
    </JudgeDist>

    <!-- 원거리 판단 -->
    <JudgeApproachAttack Package="CommonIdlePackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <!-- 초뢰섬 3연격 -->
        <Branch Weight="AobaApproachAtk^Choraisen" Condition="true" Execute="Choraisen"/>
        <!-- 폭풍 뢰섬 -->
        <Branch Weight="AobaApproachAtk^StormRaisen" Condition="true" Execute="EmpGrenadeToStorm"/>
        <!-- 약진 뢰섬 -->
        <Branch Weight="AobaApproachAtk^ChargeRaisen" Condition="true" Execute="EmpGrenadeToCharge"/>

    </JudgeApproachAttack>

    <!-- 근거리 판단-->
    <JudgeShortAttack Package="CommonIdlePackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <!-- 수직회피 EMP 패턴 -->
        <Branch Weight="AobaShortAtk^Emp" Condition="true" Execute="DodgeToEmp"/>
        <!-- 수직회피 초뢰섬 패턴 -->
        <Branch Weight="AobaShortAtk^Choraisen" Condition="true" Execute="DodgeToChoraisen"/>
        <!-- 코등이 패턴 -->
        <Branch Weight="AobaShortAtk^Tsuba" Condition="true" Execute="Tsuba"/>

    </JudgeShortAttack>
    
    <!-- 피격 리액션 판단 -->
    <JudgeHitReaction Package="CommonIdlePackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <!-- 주류 패턴-->
        <!-- 수직회피 EMP 패턴 -->
        <Branch Weight="AobaHitReaction^EMP" Condition="true" Execute="DodgeToEmp"/>
        <!-- 수직회피 초뢰섬 패턴 -->
        <Branch Weight="AobaHitReaction^Choraisen" Condition="true" Execute="DodgeToChoraisen"/>
        
        <!-- 변칙 패턴 -->
        <Branch Weight="AobaHitReaction^Tusba" Condition="true" Execute="Tsuba"/>
    </JudgeHitReaction>

    <!-- TODO: 화면에서 잘 안사라지는 방법 강구해볼 것 -->
    <DodgeToEmp Package="AobaDodgePackage">      
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="WarpChaseSet"/>

        <Branch Condition="true" Execute="EmpGrenadeToStorm"/>
        <Branch Weight="RandBoolean^True" Condition="CurrentPackageEnd" Execute="EmpGrenadeToCharge"/>
        <Branch Weight="RandBoolean^False" Condition="CurrentPackageEnd" Execute="EmpGrenadeToStorm"/>
    </DodgeToEmp>

    <!-- TODO: 화면에서 잘 안사라지는 방법 강구해볼 것 -->
    <DodgeToChoraisen Package="AobaDodgePackage">      
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <UseBranchSet Name="WarpChaseSet"/>

        <Branch Condition="CurrentPackageEnd" Execute="Choraisen"/>
    </DodgeToChoraisen>

    <Choraisen Package="AobaChoraisenPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </Choraisen>

    <EmpGrenadeToStorm Package="AobaEmpPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="StormRaisen"/>
    </EmpGrenadeToStorm>

    <StormRaisen Package="AobaChoraisenPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </StormRaisen>

    <EmpGrenadeToCharge Package="AobaEmpPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="ChargeRaisen"/>
    </EmpGrenadeToCharge>
    <ChargeRaisen Package="AobaChargeRaisenPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </ChargeRaisen>

    <UnwaverRaisen Package="AobaUnwaverRaisenPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </UnwaverRaisen>

    <!-- TODO: 전기충격 패턴으로 동작중 -->
    <Tsuba Package="AobaTsubaPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </Tsuba>

    <Raisen Package="AobaRaisenPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </Raisen>

    <WarpChase Package="AobaWarpChasePackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <!-- TODO: 너무 느리면 Attack Success로 후딜레이 끊기 -->
        <Branch Condition="CurrentPackageEnd" Execute="JudgeDist"/>
    </WarpChase>   

    <GuardBroken Package="CommonGuardBrokenPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </GuardBroken>

    <Hit Package="CommonHitPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <UseBranchSet Name="HitReactionSet"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </Hit>

    <Groggy Package="CommonGroggyPackage">
        <UseBranchSet Name="IsPlayerDead"/>
        <Branch Condition="CurrentPackageEnd" Execute="Entry"/>
    </Groggy>

    <Dead Package="CommonDeadPackage">
    </Dead>

    <EnemyWin Package="CommonIdlePackage">
    </EnemyWin>

</AIGraph>