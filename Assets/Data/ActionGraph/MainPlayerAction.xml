

<ActionGraph Name="Test" DefaultAction="Idle" DefaultFramePerSecond="4" DefaultBuff="4 5 8">

    <GlobalVariable Name="gv_DashVelocity" Value="10"/>
    <GlobalVariable Name="gv_DashFriction" Value="24"/>

    <GlobalVariable Name="gv_MoveSpeed" Value="45"/>
    <GlobalVariable Name="gv_MoveVelocityMax" Value="3"/>

    <GlobalVariable Name="gv_AttackVelocity" Value="6.5"/>
    <GlobalVariable Name="gv_AttackFriction" Value="15"/>

    <GlobalVariable Name="gv_IdleFriction" Value="8"/>

    <GlobalVariable Name="gv_rotateSpeed" Value="840"/>


    <BranchSet Name="IdleBranchSet">
        <Branch Key="getKey_Guard" Condition="true" Execute="Guard"/>
        <Branch Key="getKey_GuardBreak2 && getKey_AttackCharge" Execute="DashRoll_Kick"/>
        <Branch Key="getKey_StunShot && getKey_AttackCharge" Execute="StunShot"/>
        <Branch Key="getKey_AttackCharge == true" Execute="DashRoll"/>
        <Branch Key="getKey_NormalMove == true" Execute="MoveAll"/>
    </BranchSet>

    <BranchSet Name="StopToIdle">
    <!-- <Branch Key="getKey_Guard && getKey_AttackCharge" Condition="true" Execute="Guard"/> -->
        <Branch Key="getKey_GuardBreak2 && getKey_AttackCharge" Execute="DashRoll_Kick"/>
        <Branch Key="getKey_StunShot && getKey_AttackCharge" Execute="StunShot"/>
        <Branch Key="getKey_AttackCharge == true" Execute="DashRoll"/>
        <Branch Key="getKey_NormalMove == true" Execute="MoveAll"/>

        <Branch Condition="End == true" Execute="Idle"/>
    </BranchSet>

    <BranchSet Name="CancelBranch">
    <!-- <Branch Key="getKey_Guard && getKey_AttackCharge" Condition="true" Execute="Guard"/> -->
        <Branch Key="getKey_GuardBreak2 && getKey_AttackCharge" Condition="getFrameTag_MoveCancel" Execute="DashRoll_Kick"/>
        <Branch Key="getKey_StunShot && getKey_AttackCharge" Condition="getFrameTag_MoveCancel" Execute="StunShot"/>
        <Branch Key="getKey_AttackCharge == true" Condition="getFrameTag_MoveCancel" Execute="DashRoll"/>
        <Branch Key="getKey_NormalMove == true" Condition="getFrameTag_MoveCancel" Execute="MoveAll"/>
    </BranchSet>


    <Idle MovementType="FrameEvent" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/NewPlayer/idle/" FramePerSecond="12" XFlip="true" Loop="false">
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0"/>
        </Animation>

        <UseBranchSet Name="IdleBranchSet"/>
        <Branch Condition="AngleFlipDirectionToStick >= 90.0" Execute="Idle_Transition"/>

        <Branch Condition="End == true" Execute="Idle"/>
    </Idle>

    <Idle_Transition MovementType="FrameEvent" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/NewPlayer/idle_ing/" FramePerSecond="12" XFlip="true" Loop="false">
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0"/>
        </Animation>

        <UseBranchSet Name="IdleBranchSet"/>

        <Branch Condition="End && (AngleFlipDirectionToStick >= 90.0)" Execute="Idle_LookBack"/>
        <Branch Condition="End && (AngleFlipDirectionToStick < 90.0)" Execute="Idle"/>
        <Branch Condition="End == true" Execute="Idle_LookBack"/>
    </Idle_Transition>

    <Idle_LookBack MovementType="FrameEvent" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/NewPlayer/idle_back/" FramePerSecond="2" XFlip="true" Loop="false">
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0"/>
        </Animation>

        <UseBranchSet Name="IdleBranchSet"/>
        <Branch Condition="AngleFlipDirectionToStick < 90.0" Execute="Idle_Transition"/>

        <Branch Condition="End == true" Execute="Idle_LookBack"/>
    </Idle_LookBack>
    
    <MoveStop MovementType="FrameEvent" DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/NewPlayer/MoveStop/" FramePerSecond="16" XFlip="true" Loop="false" >
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0" Velocity="gv_MoveVelocityMax"/>
        </Animation>
        
        <UseBranchSet Name="StopToIdle"/>
        
    </MoveStop>

    <AttackStop MovementType="FrameEvent" DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/NewPlayer/attackStop/" FramePerSecond="10" XFlip="true" Loop="false" >
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0" Velocity="0"/>
        </Animation>

        <UseBranchSet Name="StopToIdle"/>
    </AttackStop>

    <KickStop MovementType="FrameEvent" DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/NewPlayer/kick_stop/" FramePerSecond="16" XFlip="true" Loop="false" >
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0" Velocity="0"/>
        </Animation>
        
        <UseBranchSet Name="StopToIdle"/>
    </KickStop>

    <MoveAll MovementType="FrameEvent" DirectionType="MousePoint" RotationType="MoveDirection" FlipType="MousePoint" FlipTypeUpdateOnce="True" RotateBySpeed="True" RotateSpeed="gv_rotateSpeed">
        <Animation Path="Resources/Sprites/NewPlayer/MoveRotate/" FramePerSecond="1" AngleBaseAnimation="True" XFlip="true">
            <FrameEvent Type="Movement" StartFrame="0" Friction="0" MaxVelocity="gv_MoveVelocityMax" Speed="gv_MoveSpeed"/>
        </Animation>

        <Branch Key="getKey_Guard && getKey_AttackCharge" Condition="true" Execute="Guard"/>

        <Branch Condition="End == true" Execute="MoveAll"/>
        <Branch Key="(getKey_AttackCharge == false) && (getKey_NormalMove == false)" Execute="MoveStop"/>
    </MoveAll>

    <DashRoll MovementType="FrameEvent" DirectionType="MousePoint" RotationType="MoveDirection" FlipType="MousePoint" DirectionUpdateOnce="true">
        <Animation Path="Resources/Sprites/NewPlayer/DashRoll/" FramePerSecond="32" XFlip="true" ScalePreset="YSpring">
            <FrameEvent Type="Attack" StartFrame="0" AttackPreset="PlayerAttackTest">
                <OnHit>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="1"/>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="TargetBattleIncrement" Condition="getTargetFrameTag_Hit == false"/>
                    <FrameEvent Type="ApplyBuff" ApplyBuff="6 7"/>

                    <FrameEvent Type="TeleportToTargetBack" DistanceOffset="-0.3"/>

                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Slash_Timeline" Offset="0.0 0.0 0.0" ToTarget="true" AngleType="AttackPoint"/>
                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Blood_Timeline" Offset="0.0 0.0 0.0" ToTarget="true" AngleType="AttackPoint"/>
                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Impact_Timeline" Offset="0.0 0.0 0.0" Attach="true" ToTarget="true" AngleType="AttackPoint"/>

                    <FrameEvent Type="StopUpdate" StartFrame="0" Time="0.07"/>
                </OnHit>
                <OnGuard>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/ProjectileHit" FramePerSecond="18.0" Offset="0.0 0.0 0.0" ToTarget="True"/>

                    <FrameEvent Type="TeleportToTarget"/>
                    <FrameEvent Type="StopUpdate" StartFrame="0" Time="0.01"/>
                </OnGuard>
                <OnParry>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnParry>

            </FrameEvent>
            <FrameEvent Type="FrameTag" StartFrame="5" EndFrame="999" Tag="MoveCancel"/>

            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_DashFriction" MaxVelocity="gv_DashVelocity" Speed="0" Velocity="gv_DashVelocity"/>
        </Animation>

        <Branch Condition="AttackSuccess" Execute="AttackSuccess"/>
        <Branch Condition="AttackGuarded" Execute="AttackGuarded"/>
        <Branch Key="getKey_AttackCharge == true" Condition="End" Execute="MoveAll"/>
        <Branch Key="getKey_AttackCharge == false" Condition="End" Execute="MoveStop"/>
        <Branch Key="getKey_AttackCharge == false" Condition="getFrameTag_MoveCancel" Execute="MoveStop"/>
    </DashRoll>

    <DashRoll_Kick MovementType="FrameEvent" DirectionType="MousePoint" RotationType="MoveDirection" FlipType="MousePoint" DirectionUpdateOnce="true">
        <Animation Path="Resources/Sprites/NewPlayer/DashRoll/" FramePerSecond="32" XFlip="true">
            <FrameEvent Type="Attack" StartFrame="0" AttackType="GuardBreak" AttackPreset="Akane_Kick" IgnoreDefenceType="Guard">
                <OnGuardBreak>
                    <FrameEvent Type="ApplyBuffTarget" StartFrame="0" ApplyBuff="21 TargetBattleIncrement"/>

                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/ParrySucc" FramePerSecond="18.0" Offset="0.0 0.0 0.0" ToTarget="true"/>
                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Impact_Timeline" Offset="0.0 0.0 0.0" Attach="true" ToTarget="true" AngleType="AttackPoint"/>

                    <FrameEvent Type="TeleportToTarget" DistanceOffset="0"/>
                    <FrameEvent Type="StopUpdate" StartFrame="0" Time="0.15"/>
                </OnGuardBreak>

                <OnGuardBreakFail>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/ParrySucc" FramePerSecond="18.0" Offset="0.0 0.0 0.0" ToTarget="true"/>

                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Impact_Timeline" Offset="0.0 0.0 0.0" Attach="true" ToTarget="true" AngleType="AttackPoint"/>

                    <FrameEvent Type="TeleportToTarget" DistanceOffset="0"/>
                    <FrameEvent Type="StopUpdate" StartFrame="0" Time="0.15"/>
                </OnGuardBreakFail>
            </FrameEvent>

            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_DashFriction" MaxVelocity="gv_DashVelocity" Speed="0" Velocity="gv_DashVelocity"/>
            <FrameEvent Type="FrameTag" StartFrame="5" EndFrame="999" Tag="MoveCancel"/>
        </Animation>
        
        <Branch Condition="AttackSuccess || AttackGuarded || AttackGuardBreak || AttackGuardBreakFail" Execute="Kicked"/>
        <Branch Key="getKey_AttackCharge == true" Condition="End" Execute="MoveAll"/>
        <Branch Key="getKey_AttackCharge == false" Condition="End" Execute="MoveStop"/>
        <Branch Key="getKey_AttackCharge == false" Condition="getFrameTag_MoveCancel" Execute="MoveStop"/>
    </DashRoll_Kick>

    <StunShot MovementType="FrameEvent" DirectionType="MousePoint" FlipType="Direction" DirectionUpdateOnce="true">
        <Animation Path="Resources/Sprites/DummyPlayer/Guard/" FramePerSecond="3" AngleBaseAnimation="True" XFlip="true" ScalePreset="XSpring">
            <FrameEvent Type="Movement" StartFrame="0" Friction="22" MaxVelocity="18" Speed="0" Velocity="-6"/>

            <FrameEvent Type="Projectile" StartFrame="0" GraphName="StunShot" DirectionType="MousePoint"/>

            <FrameEvent Type="ZoomEffect" StartFrame="0" Scale="3.1"/>
        </Animation>

        <Branch Condition="AttackSuccess" Execute="AttackSuccess"/>
        <Branch Key="getKey_AttackCharge == true" Condition="End" Execute="DashRoll"/>
        <Branch Key="getKey_NormalMove == true" Condition="End" Execute="MoveAll"/>
        <Branch Key="getKey_AttackCharge == false" Condition="End" Execute="Idle"/>
    </StunShot>

    <Kicked MovementType="FrameEvent" DirectionType="Keep" RotationType="Direction" FlipType="Direction" DirectionUpdateOnce="true">
        <Animation Path="Resources/Sprites/NewPlayer/kick/" FramePerSecond="9" XFlip="true" ScalePreset="YSpring">
            <FrameEvent Type="Movement" StartFrame="0" Friction="3" Speed="0" Velocity="-1.5 "/>
            <FrameEvent Type="Test" StartFrame="0" Log="Kicked Executed"/>

            <FrameEvent Type="FrameTag" StartFrame="3" EndFrame="999" Tag="MoveCancel"/>
        </Animation>

        <UseBranchSet Name="CancelBranch"/>
        <!-- <Branch Condition="AttackSuccess" Execute="AttackSuccess"/> -->
        <Branch Key="(getKey_AttackCharge == true) || (getKey_NormalMove == true)" Condition="End" Execute="MoveAll"/>
        <Branch Key="getKey_AttackCharge == false" Condition="End" Execute="KickStop"/>
    </Kicked>

    <AttackSuccess MovementType="FrameEvent" DirectionType="Keep" RotationType="Direction" FlipType="Direction" DirectionUpdateOnce="true">
        <Animation Path="Resources/Sprites/NewPlayer/attack/" FramePerSecond="24" XFlip="true" ScalePreset="YSpring">
            <FrameEvent Type="Effect" StartFrame="0" Path="Resources/Sprites/Effect/Sheath" FramePerSecond="0.5" Offset="0.0 0.0 0.0" Angle="Random_0^360" UseFlip="True" CastShadow="True">
                <Physics UseGravity="True" Velocity="-1.5 3.5" Friction="1.0" Torque="Random_25^30" AngularFriction="10.0"/>
            </FrameEvent>

            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_AttackFriction" MaxVelocity="gv_AttackVelocity" Speed="0" Velocity="gv_AttackVelocity"/>
        </Animation>

        <Branch Key="(getKey_AttackCharge == true) || (getKey_NormalMove == true)" Condition="End" Execute="MoveAll"/>
        <Branch Key="getKey_AttackCharge == false" Condition="End" Execute="AttackStop"/>
    </AttackSuccess>

    <AttackGuarded MovementType="FrameEvent" DirectionType="Keep" RotationType="Direction" FlipType="Keep">
        <Animation Path="Resources/Sprites/NewPlayer/Attack/" FramePerSecond="16">
            <FrameEvent Type="Movement" StartFrame="0" Friction="12" MaxVelocity="6" Speed="0" Velocity="-4"/>
        </Animation>

        <Branch Key="(getKey_AttackCharge == true) || (getKey_NormalMove == true)" Condition="End" Execute="MoveAll"/>
        <Branch Key="getKey_AttackCharge == false" Condition="End" Execute="Idle"/>
    </AttackGuarded>

    <Guard MovementType="FrameEvent" DirectionType="MousePoint" DefenceDirectionType="MousePoint" FlipType="Keep" DefenceType="Guard" DefenceAngle="180.0">
        <Animation Path="Resources/Sprites/DummyPlayer/Guard/" StartFrame="0" EndFrame="1" FramePerSecond="1" XFlip="true">
            <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/LaserTest_Timeline" Offset="0.0 0.0 0.0" Attach="true" AngleType="Direction" LifeTime="1.0" FollowDirection="True"/>
            <FrameEvent Type="Attack" StartFrame="0.3" AttackPreset="LaserTest" IgnoreDefenceType="Guard">
                <OnHit>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="1"/>
                    <FrameEvent Type="ApplyBuff" ApplyBuff="6 7"/>

                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Slash_Timeline" Offset="0.0 0.0 0.0" ToTarget="true" AngleType="AttackPoint"/>
                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Blood_Timeline" Offset="0.0 0.0 0.0" ToTarget="true" AngleType="AttackPoint"/>
                    <FrameEvent Type="TimelineEffect" Path="Prefab/Effect/Impact_Timeline" Offset="0.0 0.0 0.0" Attach="true" ToTarget="true" AngleType="AttackPoint"/>

                    <FrameEvent Type="StopUpdate" StartFrame="0" Time="0.07"/>
                </OnHit>
                <OnGuard>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/ProjectileHit" FramePerSecond="18.0" Offset="0.0 0.0 0.0" ToTarget="True"/>

                    <FrameEvent Type="StopUpdate" StartFrame="0" Time="0.01"/>
                </OnGuard>
                <OnParry>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnParry>

            </FrameEvent>

            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0"/>
        </Animation>

        <Branch Condition="End" Execute="Guard"/>
        <Branch Key="(getKey_Guard == false)" Execute="Idle"/>
    </Guard>

    <Hit MovementType="FrameEvent" DirectionType="MousePoint" DefenceDirectionType="MousePoint" FlipType="Keep" DefenceType="Guard" DefenceAngle="180.0">
        <Animation Path="Resources/Sprites/NewPlayer/Hit/" FramePerSecond="2" XFlip="true">
            <FrameEvent Type="Movement" StartFrame="0" Friction="gv_IdleFriction" Speed="0"/>
        </Animation>

        <!-- <Branch Condition="getStat_IsStun == 1.0" Execute="Stun"/> -->
        <Branch Condition="IsCatchTarget" Execute="Catched"/>
        <Branch Condition="End" Execute="Idle"/>
        <Branch Key="(getKey_Guard == false) && ((getKey_AttackCharge == true) || (getKey_NormalMove == true))" Condition="End" Execute="MoveAll"/>
        <Branch Key="(getKey_Guard == false) && (getKey_AttackCharge == false)" Condition="End" Execute="Idle"/>
    </Hit>

    <Kiiled DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/Hit/" StartFrame="0" EndFrame="1" FramePerSecond="99" XFlip="true">
            <FrameEvent Type="KillEntity" StartFrame="0"/>
        </Animation>

        <Branch Condition="End == true" Execute="Kiiled"/>
    </Kiiled>

    <Catched MovementType="FrameEvent" DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/Hit/" StartFrame="0" EndFrame="1" XFlip="true">
            <FrameEvent Type="Test" Log="Akane Catched"/>
            <FrameEvent Type="ApplyBuff" StartFrame="1" ApplyBuff="StunClear"/>
        </Animation>

        <Branch Condition="IsCatchTarget == false" Execute="CatchReleased"/>
        <Branch Condition="End == true" Execute="Catched"/>
    </Catched>

    <CatchReleased MovementType="FrameEvent" DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/Hit/" StartFrame="0" EndFrame="1" FramePerSecond="0.75" XFlip="true">
            <FrameEvent Type="Test" Log="Akane Catch Released"/>
            <FrameEvent Type="ApplyBuff" StartFrame="1" ApplyBuff="StunClear"/>
        </Animation>

        <Branch Condition="End" Execute="Idle"/>
    </CatchReleased>

    <Stun MovementType="FrameEvent" DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/JustGuardBreak/" FramePerSecond="0.3" XFlip="true">
            <FrameEvent Type="FrameTag" StartFrame="0" EndFrame="999" Tag="Stun"/>
            <FrameEvent Type="ApplyBuff" StartFrame="1" ApplyBuff="StunClear"/>
        </Animation>

        <Branch Condition="getStat_IsStun == 0.0" Execute="Idle"/>
    </Stun>

</ActionGraph>