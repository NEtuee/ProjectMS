

<ActionGraph Name="Test" DefaultAction="Idle" DefaultFramePerSecond="4" DefaultBuff="4 5 8">

    <BranchSet Name="CommonBattleBranchSet">
        <Branch Key="getKey_Guard" Condition="true" Execute="Guard"/>
        <Branch Key="getKey_AttackCharge && (getStat_Stamina >= 10.0)" Condition="" Execute="AttackCharge"/>
        <Branch Condition="(getStat_Blood >= 20.0) && InputAttackBlood == true" Execute="BloodSpreadPrepare"/>

        <Branch Condition="Hit == true" Execute="Hit"/>
    </BranchSet>

    <BranchSet Name="CommonMoveBranchSet">
        <Branch Key="getKey_Dash" Condition="(getStat_Stamina >= 20.0)" Execute="Dash"/>
        <Branch Condition="ActionTest == false" Execute="Idle"/>
    </BranchSet>

    <Idle DirectionType="Keep" FlipType="MousePoint">
        <Animation Path="Resources/Sprites/NewPlayer/idle/" StartFrame="0" EndFrame="1" FramePerSecond="1" XFlip="true">
        </Animation>

        <UseBranchSet Name="CommonBattleBranchSet"/>

        <Branch Condition="ActionTest == true" Execute="MoveAll"/>
        <Branch Condition="End == true" Execute="Idle"/>
    </Idle>

    <CommonMoveSelection IsActionSelection="true">
        <Branch Condition="ActionTest == true" Execute="MoveAll"/>
        <UseBranchSet Name="CommonMoveBranchSet"/>
    </CommonMoveSelection>


    <MoveAll MovementType="GraphPreset" MovementGraphPreset="Move" DirectionType="MoveInput" FlipType="MousePoint" NormalizedSpeed="true">
        <Animation Path="Resources/Sprites/DummyPlayer/MoveForward/" StartFrame="0" EndFrame="1" FramePerSecond="1" XFlip="true">
            <MultiSelectAnimation Path="Resources/Sprites/NewPlayer/moveUp/" Condition="(AngleDirection >= 45.0) && (AngleDirection < 135.0)"/>
            <MultiSelectAnimation Path="Resources/Sprites/NewPlayer/moveDown/" Condition="(AngleDirection >= 225.0) && (AngleDirection < 315.0)"/>
            <MultiSelectAnimation Path="Resources/Sprites/NewPlayer/moveBack/" Condition="(AngleDirection >= 315.0) || (AngleDirection < 45.0) && (IsXFlip == true)"/>
            <MultiSelectAnimation Path="Resources/Sprites/NewPlayer/moveFront/" Condition="(AngleDirection >= 135.0) && (AngleDirection < 225.0) && (IsXFlip == true)"/>
            <MultiSelectAnimation Path="Resources/Sprites/NewPlayer/moveBack/" Condition="(AngleDirection >= 135.0) && (AngleDirection < 225.0) && (IsXFlip == false)"/>
            <MultiSelectAnimation Path="Resources/Sprites/NewPlayer/moveFront/" Condition="(AngleDirection >= 315.0) || (AngleDirection < 45.0) && (IsXFlip == false)"/>
        </Animation>

        <UseBranchSet Name="CommonMoveBranchSet"/>
        <UseBranchSet Name="CommonBattleBranchSet"/>

        <Branch Condition="End == true" Execute="MoveAll"/>
    </MoveAll>


    <AttackCharge MovementType="GraphPreset" MovementGraphPreset="AttackCharge" DirectionType="MoveInput" FlipType="MousePoint" ApplyBuff="2 3">
        <Animation Path="Resources/Sprites/NewPlayer/charge/" StartFrame="0" EndFrame="1" FramePerSecond="1" XFlip="true">
        </Animation>

        <Branch Condition="Hit == true" Execute="Hit"/>
        <Branch Key="getKey_AttackCharge == false" Condition="" Execute="AttackPrepare"/>
        <Branch Condition="End == true" Execute="AttackCharge"/>
    </AttackCharge>

    <AttackPrepare MovementType="Empty" DirectionType="MousePoint" FlipType="Keep">
        <Animation Path="Resources/Sprites/NewPlayer/charge/" StartFrame="0" EndFrame="1" FramePerSecond="999">
            <FrameEvent Type="ApplyBuff" ApplyBuff="12" StartFrame="0"/>
            <FrameEvent Type="FrameTag" StartFrame="0" EndFrame="999" Tag="Attack"/>
        </Animation>

        <Branch Condition="Hit == true" Execute="Hit"/>
        <Branch Condition="End == true && (getStat_Charging >= 100.0)" Execute="Attack_LV3"/>
        <Branch Condition="End == true && (getStat_Charging >= 50.0)" Execute="Attack_LV2"/>
        <Branch Condition="End == true" Execute="Attack_LV1"/>

    </AttackPrepare>

    <Attack_Guarded MovementType="GraphPreset" MovementGraphPreset="AttackGuarded" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/DummyPlayer/Attack/" StartFrame="0" EndFrame="1" FramePerSecond="3">
        </Animation>

        <Branch Key="getKey_GuardBreak" Condition="(CurrentFrame < 0.5)" Execute="JustGuardBreak"/>
        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </Attack_Guarded>

    <JustGuardBreak DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/JustGuardBreak/" StartFrame="0" EndFrame="1" FramePerSecond="3" XFlip="true">
            <FrameEvent Type="Test" Log="Just Guard Break Executed"/>
            <FrameEvent Type="FrameTag" StartFrame="0" EndFrame="999" Tag="JustGuardBreak"/>
            <FrameEvent Type="Attack" AttackType="GuardBreak" StartFrame="0" AttackPreset="Player_JustGuardBreak" IgnoreDefenceType="Guard">
                <OnGuardBreak>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/ParrySucc" FramePerSecond="18.0" Offset="0.0 0.0 0.0" Angle="Random_0^360" ToTarget="true"/>
                </OnGuardBreak>
            </FrameEvent> 
        </Animation>
        
        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </JustGuardBreak>

    <Attack_Parried MovementType="GraphPreset" MovementGraphPreset="AttackGuarded" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/DummyPlayer/Attack/" StartFrame="0" EndFrame="1" FramePerSecond="0.3">
        </Animation>

        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </Attack_Parried>

    <Attack_Success MovementType="GraphPreset" MovementGraphPreset="AttackSuccess" DirectionType="Keep" RotationType="Keep" FlipType="Keep" NormalizedSpeed="false">
        <Animation Path="Resources/Sprites/NewPlayer/attack" StartFrame="0" EndFrame="4" FramePerSecond="12" ScalePreset="YSpring">
            <FrameEvent Type="SetAnimationSpeed" StartFrame="0"/>

            <FrameEvent Type="SetAnimationSpeed" StartFrame="0" Speed="4"/>
            <FrameEvent Type="SetAnimationSpeed" StartFrame="2" Speed="2"/>
            <FrameEvent Type="SetAnimationSpeed" StartFrame="3" Speed="0.3"/>
        </Animation>

            
        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </Attack_Success>

    <Attack_LV1 MovementType="GraphPreset" MovementGraphPreset="Attack" DirectionType="Keep" RotationType="Direction" FlipType="Keep" NormalizedSpeed="false">
        <Animation Path="Resources/Sprites/NewPlayer/attack" StartFrame="0" EndFrame="4" FramePerSecond="12" ScalePreset="YSpring">
            <FrameEvent Type="SetCameraDelay" StartFrame="0" EndFrame="0"/>
            <FrameEvent Type="SetAnimationSpeed" StartFrame="0" Speed="4"/>
            <!-- <FrameEvent Type="SetAnimationSpeed" StartFrame="0.3" Speed="2.6"/>-->
            <FrameEvent Type="SetAnimationSpeed" StartFrame="2" Speed="2"/>
            <FrameEvent Type="SetAnimationSpeed" StartFrame="3" Speed="0.3"/>

            <FrameEvent Type="Effect" StartFrame="0" Path="Resources/Sprites/Effect/Sheath" FramePerSecond="0.5" Offset="0.0 0.0 0.0" Angle="Random_0^360" UseFlip="True">
                <Physics UseGravity="True" Velocity="-1.5^3.5" Friction="1.0" Torque="Random_25^30" AngularFriction="10.0"/>
            </FrameEvent>

            <FrameEvent Type="Attack" StartFrame="0" AttackPreset="PlayerAttackTest">
                <OnHit>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="1"/>
                    <FrameEvent Type="ApplyBuff" ApplyBuff="6 7"/>

                    <FrameEvent Type="TeleportToTargetBack"/>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/AttackHit" FramePerSecond="18.0" Offset="0.0 0.0 0.0" Angle="Random_0^360" ToTarget="true"/>
                </OnHit>

                <OnGuard>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnGuard>

                <OnParry>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnParry>

            </FrameEvent>


        </Animation>

        <Branch Condition="AttackSuccess == true" Execute="Attack_Success"/>
        <Branch Condition="AttackGuarded == true" Execute="Attack_Guarded"/>
        <Branch Condition="AttackParried == true" Execute="Attack_Parried"/>
        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </Attack_LV1>
    
    <Attack_LV2 MovementType="GraphPreset" MovementGraphPreset="Attack" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/DummyPlayer/Attack/" StartFrame="0" EndFrame="1" FramePerSecond="3">
            <FrameEvent Type="Attack" StartFrame="0" AttackPreset="PlayerAttackTest">
                <OnHit>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="1"/>
                    <FrameEvent Type="ApplyBuff" ApplyBuff="6 7"/>

                    <FrameEvent Type="TeleportToTargetBack"/>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/AttackHit" FramePerSecond="18.0" Offset="0.0 0.0 0.0" Angle="Random_0^360" ToTarget="true"/>
                </OnHit>

                <OnGuard>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnGuard>

                <OnParry>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnParry>

            </FrameEvent>
        </Animation>

        <Branch Condition="AttackSuccess == true" Execute="Attack_Success"/>
        <Branch Condition="AttackGuarded == true" Execute="Attack_Guarded"/>
        <Branch Condition="AttackParried == true" Execute="Attack_Parried"/>
        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </Attack_LV2>

    <Attack_LV3 MovementType="GraphPreset" MovementGraphPreset="Attack" DirectionType="Keep" FlipType="Keep">
        <Animation Path="Resources/Sprites/DummyPlayer/Attack/" StartFrame="0" EndFrame="1" FramePerSecond="3">
            <FrameEvent Type="Attack" StartFrame="0" AttackPreset="PlayerAttackTest">
                <OnHit>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="1"/>
                    <FrameEvent Type="ApplyBuff" ApplyBuff="6 7"/>

                    <FrameEvent Type="TeleportToTargetBack"/>
                    <FrameEvent Type="Effect" Path="Resources/Sprites/Effect/AttackHit" FramePerSecond="18.0" Offset="0.0 0.0 0.0" Angle="Random_0^360" ToTarget="true"/>
                </OnHit>

                <OnGuard>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnGuard>

                <OnParry>
                    <FrameEvent Type="TeleportToTarget"/>
                </OnParry>

            </FrameEvent>
        </Animation>

        <Branch Condition="AttackSuccess == true" Execute="Attack_Success"/>
        <Branch Condition="AttackGuarded == true" Execute="Attack_Guarded"/>
        <Branch Condition="AttackParried == true" Execute="Attack_Parried"/>
        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </Attack_LV3>

    <BloodSpreadPrepare DirectionType="MousePoint" FlipType="MousePoint">
        <Animation Path="Resources/Sprites/DummyPlayer/Attack/" StartFrame="0" EndFrame="1" FramePerSecond="999">
        </Animation>

        <Branch Condition="End == true" Execute="BloodSpread"/>
    </BloodSpreadPrepare>


    <BloodSpread MovementType="GraphPreset" MovementGraphPreset="BloodSpread" DirectionType="Keep" FlipType="Keep" ApplyBuff="10">
        <Animation Path="Resources/Sprites/DummyPlayer/Attack/" StartFrame="0" EndFrame="1" FramePerSecond="2">
            <FrameEvent Type="Attack" StartFrame="0" AttackPreset="PlayerBloodSpreadTest">
                <OnHit>
                    <FrameEvent Type="ApplyBuffTarget" ApplyBuff="11"/>
                </OnHit>

            </FrameEvent>
        </Animation>

        <Branch Condition="End == true" Execute="CommonMoveSelection"/>
    </BloodSpread>


    <Guard MovementType="GraphPreset" MovementGraphPreset="Guard" DirectionType="MoveInput" DefenceDirectionType="MousePoint" FlipType="Keep" DefenceType="Guard" DefenceAngle="180.0">
        <Animation Path="Resources/Sprites/DummyPlayer/Guard/" StartFrame="0" EndFrame="1" FramePerSecond="1" XFlip="true">
            <FrameEvent Type="FrameTag" StartFrame="0" EndFrame="999" Tag="Guard"/>
            <FrameEvent Type="SetDefenceType" StartFrame="0" DefenceType="Parry"/>
            <FrameEvent Type="SetDefenceType" StartFrame="0.2" DefenceType="Guard"/>
        </Animation>

        <Branch Condition="Hit == true" Execute="Hit"/>
        <Branch Condition="getStat_Stamina <= 0.0" Execute="Hit"/>
        <Branch Key="getKey_Guard == false" Condition="" Execute="CommonMoveSelection"/>
        <!-- <Branch Condition="End == true" Execute="Guard"/> -->
    </Guard>


    <DashStart MovementType="Empty" DirectionType="Keep" FlipType="Direction" RotationType="Direction" ApplyBuff="9">
        <Animation Path="Resources/Sprites/DummyPlayer/Dash/" StartFrame="0" EndFrame="1" FramePerSecond="999" XFlip="true">
        </Animation>

        <Branch Condition="End == true" Execute="Dash"/>
    </DashStart>


    <Dash MovementType="GraphPreset" DirectionType="Keep" MovementGraphPreset="Dash" FlipType="Direction" RotationType="Direction" DefenceType="Evade" DefenceAngle="360.0">
        <Animation Path="Resources/Sprites/DummyPlayer/Dash/" StartFrame="0" EndFrame="1" FramePerSecond="3" XFlip="true">
            <FrameEvent Type="ApplyBuff" ApplyBuff="9" StartFrame="0"/>
        </Animation>
        
        <Branch Condition="Hit == true" Execute="Hit"/>
        <Branch Condition="End == true && ActionTest == true" Execute="MoveAll"/>
        <Branch Condition="End == true" Execute="Idle"/>
    </Dash>

    <Hit MovementType="GraphPreset" MovementGraphPreset="AttackHit" DirectionType="AttackedPoint" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/Hit/" StartFrame="0" EndFrame="1" FramePerSecond="2" XFlip="true">
            <FrameEvent Type="FrameTag" StartFrame="0" EndFrame="999" Tag="Hit"/>
        </Animation>

        <Branch Condition="getStat_HP <= 0.0" Execute="Dead"/>
        <Branch Condition="End == true && ActionTest == true" Execute="MoveAll"/>
        <Branch Condition="End == true" Execute="Idle"/>
    </Hit>

    <Dead DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/Hit/" StartFrame="0" EndFrame="3" FramePerSecond="1" XFlip="true">
            <FrameEvent Type="FrameTag" StartFrame="0" EndFrame="999" Tag="Hit"/>
        </Animation>

        <Branch Condition="End == true" Execute="Kiiled"/>
    </Dead>

    <Kiiled DirectionType="Keep" FlipType="Direction">
        <Animation Path="Resources/Sprites/DummyPlayer/Hit/" StartFrame="0" EndFrame="1" FramePerSecond="99" XFlip="true">
            <FrameEvent Type="KillEntity" StartFrame="0"/>
        </Animation>

        <Branch Condition="End == true" Execute="Kiiled"/>
    </Kiiled>

</ActionGraph>